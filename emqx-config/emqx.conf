## --------------------------------------------------------------------
## Node Configuration
## --------------------------------------------------------------------
node {
  name = "emqx@127.0.0.1"
  cookie = "emqxsecretcookie"
  data_dir = "/opt/emqx/data"
}

## --------------------------------------------------------------------
## Authentication (Postgres)
## --------------------------------------------------------------------

authentication = [
  {
    mechanism = password_based
    backend = postgresql
    
    server = "timescaledb:5432"
    database = "iot_db"
    username = "postgres"
    password = "password"
    
    # Enable SSL if DB requires it
    ssl {
      enable = false
    }

    # Query to verify password
    # Passwords in DB should be hashed. For POC, we assume plain or handle hashing in DB.
    # Recommended: use `password_hash` column with Argon2/Bcrypt
    query = "SELECT password_hash FROM mqtt_users WHERE username = ${username} LIMIT 1"
    
    # Hashing configuration (Matches the DB hash type)
    # password_hash_algorithm {
    #   name = sha256
    #   salt_position = suffix
    # }
    # For Plaintext (POC ONLY - NOT PRODUCTION):
    password_hash_algorithm {
        name = plain
    }
  }
]

## --------------------------------------------------------------------
## Authorization (ACLs via Postgres)
## --------------------------------------------------------------------

authorization {
  sources = [
    {
      type = postgresql
      server = "timescaledb:5432"
      database = "iot_db"
      username = "postgres"
      password = "password"
      
      ssl {
        enable = false
      }

      # Query to check permission
      # ${username}, ${clientid}, ${topic} are injected by EMQX
      # We check for specific user rules OR generic '$all' rules
      query = "SELECT action, permission, topic FROM mqtt_acl WHERE username = ${username} OR username = '$all'"
    },
    
    # Fallback: Deny everything else
    {
      type = file
      path = "${EMQX_ETC_DIR}/acl.conf"
    }
  ]
}

## --------------------------------------------------------------------
## Listeners
## --------------------------------------------------------------------

listeners.tcp.default {
  bind = "0.0.0.0:1883"
  max_connections = 1024000
}

## SSL Listener (MQTTS) - Requires Certificates
# listeners.ssl.default {
#   bind = "0.0.0.0:8883"
#   ssl_options {
#     keyfile = "/etc/emqx/certs/key.pem"
#     certfile = "/etc/emqx/certs/cert.pem"
#   }
# }

## --------------------------------------------------------------------
## Dashboard
## --------------------------------------------------------------------
dashboard {
    listeners.http {
        bind = 18083
    }
}
